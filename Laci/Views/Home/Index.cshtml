@model List<City>
@{
    ViewData["Title"] = "LACI";
}
@section StyleSheets{
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/chartist.js/latest/chartist.min.css">
}

<div class="card">
    <div class="card-header">
        <select id="cities" class="selectpicker" data-live-search="true" data-style="btn-secondary" title="Please select your city">
            <option></option>
            @foreach (var city in Model)
            {
                <option value="@city.Id">@city.Name</option>
            }
        </select>
        <select id="types" class="selectpicker" data-style="btn-secondary">
            <option>Cases</option>
            <option>Deaths</option>
            <option>Tests</option>
        </select>
        <span id="date-range"></span>
    </div>
    <div class="car-body">
        <div class="ct-chart bg-white"></div>
    </div>
</div>

@section Scripts{
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
    <script src="https://cdn.jsdelivr.net/chartist.js/latest/chartist.min.js"></script>
    <script>
        var chart;
        var labels = [];
        var series = {
            Cases: [],
            Deaths: [],
            Tests: []
        }
        function drawChart() {
            var data = {
                labels,
                series: [series[$("#types").val()]]
            };
            console.log(data);
            if (chart) chart.update(data);
            else {
                chart = new Chartist.Line('.ct-chart', data, {
                    axisX: {
                        showLabel: true,
                        labelInterpolationFnc: function (value, index) {
                            return index == 0 || index == labels.length - 1 ? value : "";
                        }
                    }
                });
                $("#types").prop("disabled", false);
                $("#types").selectpicker("refresh");
            }
        }
        function getData(cityId) {
            $.ajax({
                url: `api/cities/${cityId}/records`,
                success: function (data) {
                    labels = data.map(r => (new Date(r.date)).toLocaleDateString());
                    series = {
                        Cases: data.map(r => r.cases),
                        Deaths: data.map(r => r.deaths),
                        Tests: data.map(r => r.tests)
                    };
                    drawChart();
                }
            });
        }
        $(function () {
            $("#types").prop("disabled", true);
            $("#types").selectpicker("refresh");
            var cityId = localStorage.getItem("cityId");
            if (cityId) {
                $("#cities").selectpicker("val", cityId);
                getData(cityId);
            }
            $("#cities").change(function () {
                cityId = $("#cities").val();
                if (cityId) {
                    localStorage.setItem("cityId", cityId);
                    getData(cityId);
                }
            });
            $("#types").change(function () {
                drawChart();
            });
        });
    </script>
}